# CatCTF CRYPTO方向 了不起的盖茨比

by zijeff

初看这道题目会发现这道题是将AES加密和异或运算放在一起考察，当你想要按照常规思路将加密逻辑逆着写得到解密方法时，你会发现行不通，因为我们缺失了最初的iv的值。

所以这道题涉及到了特殊的攻击方式——MTP攻击。

这里给出一篇参考文章，可以帮助我们更好理解MTP攻击背后的数学原理。

文章链接：[](https://www.ruanx.net/many-time-pad/)

简而言之，MTP攻击基于的是异或运算的数学性质。假设我们有两段明文M1和M2，它们通过同一个密钥K进行异或加密得到密文C1和C2。那么，根据异或运算的性质我们很容易得到下面的式子：
$$
C_1 \oplus C_2 = (M_1 \oplus K) \oplus (M_2 \oplus K) = M_1 \oplus (K \oplus K) \oplus M2 = M_1 \oplus M_2
$$
也就是说，密文之间的异或等于对应明文之间的异或。又根据上面那篇文章所提到的ASCII码中空格的特殊作用，所以我们可以通过推断空格的位置从而反推出整个明文，文章里也给了相关统计使用的代码，可以自行了解。

接下来，我们着重讲解如何在这道题中运用MTP攻击。

首先我们明白，MTP攻击的标准形式是：
$$
C_i = M_i \oplus K 
$$
然后让c这个列表为所有密文的集合，带入解出答案。

我们再来看这道题目，我们不难发现其加密逻辑是这样的：
$$
m_1 = s_1 \oplus iv_1
$$

$$
iv_2 = s_1 \oplus c_1
$$

$$
m_2 = s_2 \oplus iv_2
$$

$$
……
$$

也就是说，题目是将明文的一部分先用异或运算加密，再用AES加密得到的结果与明文异或更新iv向量。

那我们试试下面这个式子：
$$
m_2 \oplus c_1 = s_2 \oplus iv_2 \oplus c_1 = s_2 \oplus s_1 \oplus c_1 \oplus c_1 = s_2 \oplus s_1
$$
太好了，我们的尝试起到作用了。m2与c1的异或就是对应明文的异或，已经有MTP攻击的样子了。

那我们可以尝试证明这个式子：
$$
m_i \oplus c_{i-1} = s_i \oplus s_{i-1}
$$
证明不难，用一下数学归纳法即可。

记住不要忘记了我们的目标是将式子整理成这样的形式：
$$
s_i \oplus K = 已知的东西
$$
那我们做一下迭代操作：
$$
m_i \oplus c_{i-1} \oplus m_{i-1} \oplus c_{i-2}...m_2 \oplus c_1 \oplus m_1 = s_i \oplus s_{i-1} \oplus s_{i-1} \oplus s_{i-2}...\oplus s_{1} \oplus iv_1
$$
化简一下这个看似复杂的式子，得到结果：
$$
s_i \oplus iv_1
$$
大功告成，我们整理出了MTP攻击的形式，可以带入攻击了。

运行后得到结果是：***CatCTF{This's_why_PCBC_is_not_living}***